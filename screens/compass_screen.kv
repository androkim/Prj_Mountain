# screens/compass_screen.kv
#:kivy 2.2.1
#:import dp kivy.metrics.dp
#:import DEFAULT_FONT kivy.core.text.DEFAULT_FONT
#:import Window kivy.core.window.Window

<CompassScreen>:
    name: "compass_screen"
    current_azimuth: 0 # Python 클래스의 NumericProperty와 바인딩
    md_bg_color: 0.95, 0.95, 0.95, 1

    FloatLayout:
        # 1. 상단 앱 바 (뒤로 가기 버튼과 제목)
        MDTopAppBar:
            title: "나침반"
            pos_hint: {'top': 1}
            elevation: 4
            left_action_items: [['arrow-left', lambda x: root._go_back_to_main_screen()]]
            specific_text_color: 0, 0, 0, 1 # 검은색 텍스트
            md_bg_color: 0.8, 0.8, 0.8, 1 # 회색 배경

        # 2. 나침반 테두리 이미지 (고정)
        # 이 이미지는 바늘보다 먼저 그려져서 나침반 배경이 됩니다.
        Image:
            source: 'images/compass_dial.png' # 나침반 눈금이 그려진 배경 이미지 경로
            size_hint: 0.8, 0.8 # 이미지 크기 (화면의 80%)
            pos_hint: {'center_x': 0.5, 'center_y': 0.55} # 화면 중앙보다 약간 위에 배치
            allow_stretch: True # 이미지 비율 유지
            keep_ratio: True # 이미지 비율 유지

        # 3. 나침반 이미지 (회전)
        Image:
            source: 'images/compass_needle.png'
            size_hint: 0.7, 0.7 # 크기 조절
            pos_hint: {'center_x': 0.5, 'center_y': 0.55}
            allow_stretch: True
            keep_ratio: True
            # 나침반 바늘 이미지를 센서 값에 따라 회전시킵니다.
            # 0도는 북쪽 (위)을 가리키도록 이미지를 준비해야 합니다.
            # rotate 값은 (360 - current_azimuth)여야 시계방향으로 정방향 회전
            canvas.before:
                PushMatrix
                Rotate:
                    angle: -root.current_azimuth # 0도가 위를 가리키도록 이미지 준비 후 역방향 회전
                    axis: 0, 0, 1
                    origin: self.center
            canvas.after:
                PopMatrix

        # 3. 방위각 텍스트 표시 (가운데 하단)
        MDLabel:
            text: f"방위각: {int(root.current_azimuth)}°" # 소수점 없이 정수로 표시
            halign: "center"
            font_name: "NotoSansKR"
            font_style: "H4"
            pos_hint: {'center_x': 0.5, 'center_y': 0.25}
            size_hint_y: None
            height: self.texture_size[1]
            theme_text_color: "Custom"
            text_color: 0, 0, 0, 1