# android_build.yml
name: Android APK Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # 수동 실행 트리거: GitHub 웹에서 직접 실행할 수 있도록 함

jobs:
  build:
    runs-on: ubuntu-22.04 # GitHub Actions에서 안정적인 Ubuntu 22.04 환경 사용

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4 # 프로젝트 코드 가져오기

    - name: Set up Python and Dependencies
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' # 검증된 Python 3.10 버전 사용
    
    # --- Buildozer 및 핵심 파이썬 의존성 설치 ---
    - name: Install Buildozer and Dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # Buildozer와 Cython을 설치 (최신 버전 사용 권장)
        pip install buildozer cython 
        pip install appdirs packaging colorama jinja2 toml build # 기타 Buildozer 관련 의존성

    - name: Set up Java Development Kit (JDK)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17' # 검증된 JDK 17 버전 사용

    # --- Buildozer 및 Kivy 관련 모든 캐시를 강제로 삭제 (jnius.c 오류 방지 핵심) ---
    - name: Force Clean All Buildozer and Kivy Caches
      run: |
        echo "Removing all Buildozer caches and temporary build files for a clean start."
        # $HOME/.buildozer에는 SDK, NDK, 빌드 캐시 등이 저장되어 있어 이를 삭제하여 환경을 초기화합니다.
        rm -rf "$HOME/.buildozer" 
        rm -rf "$HOME/.local/share/kivy-android"
        echo "All relevant Buildozer and Kivy caches completely removed."
        
    # --- Android SDK Command-line Tools 설치 (Buildozer의 내부 경로에) ---
    - name: Install Android SDK Command-line Tools
      run: |
        BUILD_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk" # Buildozer가 찾을 최종 SDK 경로
        mkdir -p "${BUILD_SDK_ROOT}/cmdline-tools"
        # SDK Command-line Tools 다운로드 및 압축 해제
        curl -L https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip -o android-cmdline-tools.zip
        unzip -q android-cmdline-tools.zip -d "${BUILD_SDK_ROOT}/cmdline-tools"
        # latest 폴더로 이동 (sdkmanager 실행에 필요)
        mv "${BUILD_SDK_ROOT}/cmdline-tools/cmdline-tools" "${BUILD_SDK_ROOT}/cmdline-tools/latest" 
      env: 
        ANDROID_SDK_ROOT: "$HOME/.buildozer/android/platform/android-sdk"

    # --- Android SDK Tools를 PATH에 추가 및 환경 변수 설정 ---
    - name: Configure Android SDK Environment Variables
      run: |
        BUILD_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
        # 환경 변수 설정
        echo "ANDROID_SDK_ROOT=${BUILD_SDK_ROOT}" >> "$GITHUB_ENV" 
        echo "ANDROID_HOME=${BUILD_SDK_ROOT}" >> "$GITHUB_ENV"
        # PATH 설정
        echo "${BUILD_SDK_ROOT}/cmdline-tools/latest/bin" >> "$GITHUB_PATH" 
        echo "${BUILD_SDK_ROOT}/platform-tools" >> "$GITHUB_PATH"
        # 레거시 경로 (안전하게 유지)
        mkdir -p "${BUILD_SDK_ROOT}/tools/bin"
        ln -sf "${BUILD_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" "${BUILD_SDK_ROOT}/tools/bin/sdkmanager"

    # --- Android SDK 라이선스 동의 ---
    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses

    # --- 필수 Android SDK, Build-Tools, NDK 설치 ---
    # buildozer.spec에 정의된 버전과 일치하도록 확인하세요.
    - name: Install Required Android Components
      run: |
        sdkmanager \
          "platforms;android-33" \
          "build-tools;33.0.2" \
          "ndk;25.2.9519653" \
          "platform-tools" \
          --sdk_root="$HOME/.buildozer/android/platform/android-sdk"

    # --- 네이티브 라이브러리 빌드를 위한 Autotools 의존성 설치 ---
    - name: Install Autotools dependencies for native libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y autoconf automake libtool m4 pkg-config patch

    # --- Build Android APK (Debug) ---
    - name: Build Android APK (Debug)
      run: |
        # NDK 경로를 환경 변수에 명시적으로 설정하여 Buildozer가 정확히 찾도록 합니다.
        NDK_PATH="$HOME/.buildozer/android/platform/android-sdk/ndk/25.2.9519653"
        export ANDROID_NDK_HOME=$NDK_PATH
        export ANDROID_NDK_ROOT=$NDK_PATH
        
        # 이전 빌드에서 문제가 되었던 공백 경로 사용을 피하도록 Buildozer에 맡기고 바로 빌드 시작
        buildozer android debug
      
    # --- 빌드된 APK 파일을 아티팩트로 업로드 ---
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: my-app-apk
        path: bin/*.apk